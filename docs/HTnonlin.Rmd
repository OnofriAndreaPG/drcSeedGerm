---
title: "Fitting nonlinear regression models for seed germination"
csl: european-journal-of-agronomy.csl
date: "7 December, 2018"
output:
  pdf_document:
    toc: yes
  html_document:
    keep_md: no
    toc: no
    toc_float:
      collapsed: no
      smooth_scroll: no
bibliography: drcSeedGerm.bib
---

```{r setup, cache = F, echo = F}
#Put at the beginning
knitr::knit_hooks$set(document = function(x){ 
  gsub("```\n*```r*\n*", "", x) 
})
```


#Introduction {-}

One relevant task in seed biology is to model the progress to germination, depending on environmental conditions, mainly temperature and water availability. These models are usually known as hydro-time (HT), thermal-time (TT) and hydrothermal-time (HTT) models; they have usually been formulated as nonlinear regression models, where the proportion of germinated seeds is used as the response variable. In our previous papers, my collegues and I have often recommended that this is not an optimal solution [@onofri_current_2010; @onofri_hydrothermal-time_2018; @OnofriEtAl2010_Survival]; instead, we have advocated the use of time-to-event methods, which fully respect the actual manner in which data are acquired from germination assays. In contrast to nonlinear regression, time-to-event methods produce reliable estimates of parameters and standard errors [@Ritz2012_CureModel]. In this vein, we have shown that HT, TT and HTT models can also be formulated into a time-to-event framework [@onofri_hydrothermal-time_2018].

However, we need to admit that there are several nonlinear regression models that have, so far, proven useful to describe the time course in the proportion of germinated seeds, as affected by temperature and humidity content in the environment. These models are based on realistic biological underpinnings and we do understand that biologists may be reluctant to abandon them, in favour of a relatively new modelling framework. As we are trying to build a unified approach to seed germination modelling, we feel that we should also include nonlinear regression models, together with the necessary facilities to perform reasonably correct analyses.

# A brief overview of HT modeling {-}

Let's focus on hydro-time models (we'll leave TT and HTT models for another note). The fundamental idea is that the germination of a single seed is driven by its capacity to absorb water from the substrate as quickly as possible. It all depends on its base water potential $\Psi_b$: if this is low (much lower than the water potential in the environment), water flows in quickly, and the seed germinates in a short time. Otherwise, the seed germinate slowly, or it does not germinate at all, when its base water potential is equal to or higher than the environmental water potential.

We can model this by using the following equation [@Bradford2002_HydroTime]:

$$
GR = \left\{ \begin{array}{cc}
\frac{\Psi - \Psi_b}{\theta_H} & if \quad \Psi_b < \Psi \\
0 & if \quad \Psi_b \geq 0
\end{array} \right.
$$


where GR is the germination rate for one seed (GR: the relative progress to germination accomplished in one day), $\Psi_b$ is the base water potential for that seed (MPa), $\Psi$ is the water potential in the substrate (MPa) and $\theta_H$ is the hydrotime to germination (in MPa h or MPa d unit).

Considering that germination time is the inverse of GR, we can easily get to the following equation:

$$\Psi_b = \Psi - \frac{\theta_H}{t}$$

What does this equation tell us? Let's assume that the hydrotime to germination is 10 $MPa \, d$ and the environmental water potential is -1 $MPa$. A single seed germinates in exactly one day, if its base water potential is $ -1 - 10/1 = -11 $. If the base water potential is higher, germination will take more than one day, if it is lower, germination will take less than one day. But now, the following questions come: how many seeds in a population will be able to germinate in one day? And in two days? And in $n$ days?

We know that the seeds within a population do not germinate altogether in the same moment. According to @Bradford2002_HydroTime, the reason is that they have different values of base water potential. If the population is big enough, we can describe the variation of $\Psi_b$ within the population by using some density function, possibly parameterised by way of a location ($\mu$) and a scale ($\sigma$) parameter:

$$ \Psi_b \sim \phi \left( \frac{\Psi_b - \mu}{\sigma} \right) $$

This is easier to understand if we make a specific example. Let's assume that the distribution of $\Psi_b$ values within the population is gaussian, with mean equal to $\mu$ and standard deviation equal to $\sigma$. Let's also assume that the hydrotime parameter ($\theta_H$) is constant within the population. If we take, e.g., $\mu = -9$ and $\sigma = 1$, we have the situation depicted in the figure below. 

```{r distribPsi, width='90%', echo=F}
curve(dnorm(x, -9, 1), xlim = c(-18, 0), 
      xlab="Base water potential", ylab = "Density")
valori.rosso <- seq(-15, -11, length=100)
x.rosso<-c(-15, valori.rosso, -11)
y.rosso<-c(0, dnorm(valori.rosso, -9, 1), 0)
polygon(x.rosso, y.rosso,density=50, angle=45, col="red")
```

The red left tail represents the proportion of seeds that germinate during the first day. This is easily determined by using the equations above, as the proportion of seeds with base water potentials equal to or lower than -11. It corresponds to 0.228 and it easily determined by using the gaussian Cumulative Density Function (CDF):

```{r}
pnorm(-1 - 10/1, mean = -9, sd = 1)
```

More generally, we can write:

$$ G(t, \Psi) = \Phi \left\{ \frac{\Psi - (\theta_T / tg) -\mu }{\sigma} \right\} $$

where $\Phi$ is the selected cumulative distribution function. The above model returns the proportion of germinated seeds (G), as a function of time and water potential in the substrate [@Bradford2002_HydroTime]. The response variable is the proportion of germinated seeds; therefore, this model is usually fit by nonlinear regression, after turning the observed counts of germinated seeds into proportions.


# Implementation of HT models

We implemented this model in R as the function 'HTnorm()'. This function is available within the 'drcSeedGerm' package (**insert citation**) and it is meant to be used with the 'drm()' function, in the 'drc' package [@Ritz:2015aa].

However, we did not stop here. More recent work has shown that the distribution of base water potential within the population may not be gaussian. Therefore, we implemented most of the models suggested by @Mesgaran2013_SeedGermDistributions; in all, we implemented HT models based on the following distributions for base water potential:

1. gaussian distribution (function 'HTnorm()')
2. logistic distribution (function 'HTL()')
3. Gumbel (function 'HTG()')
4. log-logistic (function 'HTLL()')
5. Weibull (Type I)  (function 'HTW1()')
6. Weibull (Type II) (function 'HTW2()')

The equations are given at the end of this note. All distributions are parameterised by using location and scale parameters; for gaussian, logistic and log-logistic distributions, the location parameter corresponds to the median base water potential within the population ($\Psi_{b(50)}$).  For the gaussian distribution, the scale parameter corresponds to the standard deviation of $\Psi_b$, that is $\sigma_{\Psi b}$.

Distributions based on logarithms (the log-logistic and all other distributions thereafter) are only defined for positive amounts. On the contrary, we know that base water potential is mostly negative. Therefore, shifted distributions need to be used, by introducing a shifting parameter $\delta$ which 'moves' the distribution to the left, along the x-axis, so that negative values are possible [@Mesgaran2013_SeedGermDistributions].

# An example

The germination of rapeseed (*Brassica napus* L. var. *oleifera*, cv. Excalibur) was tested at thirteen different water potentials (-0.03, -0.15, -0.3, -0.4, -0.5, -0.6, -0.7, -0.8, -0.9, -1, -1.1, -1.2, -1.5 MPa), which were created by using a polyethylene glycol solution (PEG 6000). For each water potential level, three replicated Petri dishes with 50 seeds were incubated at 20Â°C. Germinated seeds were counted and removed every 2-3 days for 14 days.

In our lab, data from germination assays are usually collected in the following form:

```{r echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, results="asis"}
library(knitr)
library(drcSeedGerm)
data(rapeOr)
kable(rapeOr)
```

Indeed, we have one row per Petri dish, with related water potential value and the counts observed at each assessment time. First of all, we need to transform the dataset in a form that is useful for nonlinear regression. I.e., we need to have one row per each combination of dish and observation time and several columns, to list all necessary information, including the cumulative proportion of germinated seeds. 

The original dataset is available within the 'drcSeedGerm' package; it can be transformed by using the 'makeNlin()' function contained in the same package. 

```{r}
library(drcSeedGerm)
data(rapeOr)
rape <- makeNlin(rapeOr[,4:9], rapeOr[,1:2], rapeOr$nInit, c(3, 4, 5, 7, 10, 14))
head(rape, 10)
```

We can now fit all nonlinear HT models, considering all the possible distributions of base water potential. We would like to highlight that starting values are not necessary, as self-starting routines are alreay implemented for all models.

```{r}
library(drc)
mod1 <- drm(propCum ~ Time + Psi, data = rape, fct = HTnorm())
mod2 <- drm(propCum ~ Time + Psi, data = rape, fct = HTL())
mod3 <- drm(propCum ~ Time + Psi, data = rape, fct = HTG())
mod4 <- drm(propCum ~ Time + Psi, data = rape, fct = HTLL())
mod5 <- drm(propCum ~ Time + Psi, data = rape, fct = HTW1())
mod6 <- drm(propCum ~ Time + Psi, data = rape, fct = HTW2())

AIC(mod1, mod2, mod3, mod4, mod5, mod6)
```

According to the Akaike's Information Criterion (AIC; @akaike_new_1974), we note that the gaussian distribution is the worse fitting among all candidate models, while the log-logistic is the best one. Let's take a look at the value of estimated parameters.

```{r}
summary(mod4)
```

Previous papers have shown that standard errors obtained with a nonlinear regression fit may be strongly underestimated [@Ritz2012_CureModel]. More accurate standard errors can be obtained by using either a fully iterated delete-a-group jackknike estimator  [@onofri_experimental_2014] or a cluster-robust sandwich estimator. Both can be calculated by using either the function 'jackGroupSE()' in the 'drcSeedGerm' package, or the function 'coeftest', together with the facilities provided in the 'drc', 'sandwich' and 'lmtest' packages [@Ritz:2015aa; @berger_various_2017; @Zeileis2002].

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
#library(devtools)
#install_github("OnofriAndreaPG/drcSeedGerm")
library(sandwich); library(lmtest)
jack <- jackGroupSE(mod4, data = rape, cluster = rape$Dish)
sand <- coeftest(mod4, vcov = vcovCL, cluster = rape$Dish)
```

```{r}
jack
sand
```

Standard errors from nonlinear regression confirm to be smaller than sandwich and jackknife SEs. These latter two are very similar, although jackknife SEs are slightly higher.

We might be interested in getting the GR values for a certain percentile (e.g. GR50, GR30), which is easily accomplished by using the 'GR()' function in 'drcSeedGerm'. Likewise, if we are interested in the germination times for a certain percentile (e.g. T50, T30), we can use the 'GTime()' function in the same package. In the code below, we request the GR30, GR50 and GR70, as well as T30, T50 amd T70, for a water potential level of 0 MPa.

```{r}
GRate(mod4, respLev=c(30, 50, 70), x2 = 0, vcov. = vcovCL)
GTime(mod4, respLev=c(30, 50, 70), x2 = 0, vcov. = vcovCL)
```

Both functions are wrappers for the 'ED()' function in 'drc'. These wrappers reverse the behaviour of the 'ED()' function, in the sense that they consider, by default, the percentiles for the whole population, including the ungerminated fraction. That is, the, e.g., T50 would be the time to 50% germination; if this germination level is not reached at all, the function returns infinity. We believe that, with germination assays, considering the percentiles for the whole population is more meaningful for comparing different populations. Again, the use of cluster-robust standard errors is highly recommended.

We can also make predictions about the germinated proportion for a certain time and water potential level. The code below returns the maximum germinated proportions at -1.5, -0.75, and 0 MPa.

```{r}
predictSG(mod4, se.fit=T, vcov. = vcovCL,
        newdata = data.frame(Time=c(10, 10, 10), 
                             Psi=c(-1.5, -0.75, 0))
        )
```



```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# germ <- 1/(1 + exp(-(log((0 - thetaH/10 + delta)/(Psib50 + delta))/sigma)))
# b <- coef(mod4)
# names(b) <- c("thetaH", "delta", "Psib50", "sigma")
# varCov <-  vcov(mod4)

# library(car)
# deltaMethod(object=b, g="1/(1 + exp(-(log((-1 - thetaH/10 + delta)/(Psib50 + delta))/sigma)))", vcov=varCov)
```

Predictions may also be used to plot graphs.

```{r echo=FALSE}
pred <- predictSG(mod4, se.fit=T, vcov. = vcovCL,
        newdata = data.frame(Time=seq(0, 14, 0.1), 
                             Psi=rep(-0.8, 141)) )
plot(propCum ~ Time, data=rape, subset=c(Psi == -0.8), ylim=c(0,1), 
  xlab="Time (d)",
  ylab = "Proportion of germinated seeds",
  xlim=c(0, 14))
lines(pred[,1] ~ seq(0, 14, 0.1), col = "red")
```


#Detail on the equations

The equation for the model based on gaussian distribution has already been presented before. Here, we show all other equations, as implemented in our package.

## Logistic distribution

$$ G(t, \Psi) = \frac{1}{1 + exp \left[ - \frac{  \Psi  - \left( \theta _H/t \right) - \Psi_{b(50)} } {\sigma}  \right] }$$


## Gumbel distribution

$$ G(t, \Psi) = \exp \left\{ { - \exp \left[ { - \left( {\frac{{\Psi - (\theta _H / t ) - \mu }}{\sigma }} \right)} \right]} \right\} $$


## Log-logistic distribution

$$ G(t, \Psi) = \frac{1}{1 + \exp \left\{ \frac{ \log \left[ \Psi  - \left( \frac{\theta _H}{t} \right) + \delta \right] - \log(\Psi_{b50} + \delta)  }{\sigma}\right\} }$$



## Weibull distribution (Type I)

$$ G(t, \Psi) = exp \left\{ - \exp \left[ - \frac{ \log \left[ \Psi  - \left( \frac{\theta _H}{t} \right) + \delta \right] - \log(\Psi_{b50} + \delta)  }{\sigma}\right] \right\}$$

## Weibull distribution (Type II)

$$ G(t, \Psi) = 1 - exp \left\{ - \exp \left[ \frac{ \log \left[ \Psi  - \left( \frac{\theta _H}{t} \right) + \delta \right] - \log(\Psi_{b50} + \delta)  }{\sigma}\right] \right\}$$

## References
