---
title: "Fitting nonlinear regression models for seed germination"
csl: european-journal-of-agronomy.csl
date: "7 December, 2018"
output:
  pdf_document:
    toc: yes
  html_document:
    keep_md: no
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
bibliography: drcSeedGerm.bib
---

# DA VERIFICARE!!!!!!!!!!#################################################

# An example

The germination of rapeseed (*Brassica napus* L. var. *oleifera*, cv. Excalibur and Toccata) was tested at thirteen different water potentials (-0.03, -0.15, -0.3, -0.4, -0.5, -0.6, -0.7, -0.8, -0.9, -1, -1.1, -1.2, -1.5 MPa), which were created by using a polyethylene glycol solution (PEG 6000). For each water potential level, three replicated Petri dishes with 50 seeds were incubated at 20Â°C. Germinated seeds were counted and removed every 2-3 days for 14 days.

The dataset is already sorted out for time-to-event analysis and it is available in the 'drcSeedGermPackage' as 'rape2G'. In order to use this dataset for nonlinear regression analyses, we need to remove all rows where 'timeAf = Inf'.

```{r}
library(drc)
library(drcSeedGerm)
data(rape2G)
head(rape2G)
```

We can now fit all nonlinear HT models, considering all the possible distributions of base water potential. We would like to highlight that starting values are not necessary, as self-starting routines are alreay implemented for all models.

```{r}
library(drc)
mod1 <- drm(Prop ~ timeAf + Psi, data = rape2G, 
  fct = HTnorm(), curveid = CV)
mod2 <- drm(Prop ~ timeAf + Psi, data = rape2G, 
  fct = HTL(), curveid = CV)
mod3 <- drm(Prop ~ timeAf + Psi, data = rape2G,
  fct = HTG(), curveid = CV)
mod4 <- drm(Prop ~ timeAf + Psi, data = rape2G,
  fct = HTLL(), curveid = CV)
mod5 <- drm(Prop ~ timeAf + Psi, data = rape2G,
  fct = HTW1(), curveid = CV)
mod6 <- drm(Prop ~ timeAf + Psi, data = rape2G, 
  fct = HTW2(), curveid = CV)

AIC(mod1, mod2, mod3, mod4, mod5, mod6)
```

According to the Akaike's Information Criterion (AIC; @akaike_new_1974), we note that the gaussian distribution is the worse fitting among all candidate models, while the log-logistic is the best one. Let's take a look at the value of estimated parameters.

```{r}
summary(mod4)
```

Previous papers have shown that standard errors obtained with a nonlinear regression fit may be strongly underestimated [@Ritz2012_CureModel]. More accurate standard errors can be obtained by using either a fully iterated delete-a-group jackknike estimator  [@onofri_experimental_2014] or a cluster-robust sandwich estimator. Both can be calculated by using either the function 'jackGroupSE()' in the 'drcSeedGerm' package, or the function 'coeftest', together with the facilities provided in the 'drc', 'sandwich' and 'lmtest' packages [@Ritz:2015aa; @berger_various_2017; @Zeileis2002].

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
#library(devtools)
#install_github("OnofriAndreaPG/drcSeedGerm")
library(sandwich); library(lmtest)
jack <- jackGroupSE(mod4, data = rape2G, cluster = rape2G$Dish)
#sand <- coeftest(mod4, vcov = vcovCL, cluster = rape2G$Dish)
```

```{r}
jack
sand
```

Standard errors from nonlinear regression confirm to be smaller than sandwich and jackknife SEs. These latter two are very similar, although jackknife SEs are slightly higher.

We might be interested in getting the GR values for a certain percentile (e.g. GR50, GR30), which is easily accomplished by using the 'GR()' function in 'drcSeedGerm'. Likewise, if we are interested in the germination times for a certain percentile (e.g. T50, T30), we can use the 'GTime()' function in the same package. In the code below, we request the GR30, GR50 and GR70, as well as T30, T50 amd T70, for a water potential level of 0 MPa.

```{r}
ED(mod4, respLev=c(30, 50, 70), type = "absolute", Psi=0)
GRate(mod4, respLev=c(30, 50, 70), x2 = 0, vcov. = vcovCL)
GTime(mod4, respLev=c(30, 50, 70), x2 = 0, vcov. = vcovCL)
```

Both functions are wrappers for the 'ED()' function in 'drc'. These wrappers reverse the behaviour of the 'ED()' function, in the sense that they consider the percentiles for the whole population, including the ungerminated fraction. That is, the, e.g., T50 would be the time to 50% germination; if this germination level is not reached at all, the function returns infinity. We believe that, with germination assays, considering the percentiles for the whole population is more meaningful for comparing different populations. Again, the use of cluster-robust standard errors is highly recommended.

We can also make predictions about the germinated proportion for a certain time and water potential level. The code below returns the maximum germinated proportion at -1.5, -0.75, and 0 MPa.

```{r}
predictSG(mod4, se.fit=T, vcov. = vcovCL,
        newdata = data.frame(Time=c(1, 2, 3), 
                             Psi=c(0, 0, 0),
          CV = c("Excalibur", "Excalibur", "Toccata"))
        )
```



```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# germ <- 1/(1 + exp(-(log((0 - thetaH/10 + delta)/(Psib50 + delta))/sigma)))
# b <- coef(mod4)
# names(b) <- c("thetaH", "delta", "Psib50", "sigma")
# varCov <-  vcov(mod4)

# library(car)
# deltaMethod(object=b, g="1/(1 + exp(-(log((-1 - thetaH/10 + delta)/(Psib50 + delta))/sigma)))", vcov=varCov)
```

Predictions may also be used to plot graphs.

```{r echo=FALSE}
pred <- predictSG(mod4, se.fit=T, vcov. = vcovCL,
        newdata = data.frame(Time=seq(0, 14, 0.1), 
                             Psi=rep(-0.8, 141)) )
plot(propCum ~ Time, data=rape, subset=c(Psi == -0.8), ylim=c(0,1), 
  xlab="Time (d)",
  ylab = "Proportion of germinated seeds",
  xlim=c(0, 14))
lines(pred[,1] ~ seq(0, 14, 0.1), col = "red")
```


#Detail on the equations

The equation for the model based on gaussian distribution has already been presented before. Here, we show all other equations, as implemented in our package.

## Logistic distribution

$$ G(t, \Psi) = \frac{1}{1 + exp \left[ - \frac{  \Psi  - \left( \theta _H/t \right) - \Psi_{b(50)} } {\sigma}  \right] }$$


## Gumbel distribution

$$ G(t, \Psi) = \exp \left\{ { - \exp \left[ { - \left( {\frac{{\Psi - (\theta _H / t ) - \mu }}{\sigma }} \right)} \right]} \right\} $$


## Log-logistic distribution

$$ G(t, \Psi) = \frac{1}{1 + \exp \left\{ \frac{ \log \left[ \Psi  - \left( \frac{\theta _H}{t} \right) + \delta \right] - \log(\Psi_{b50} + \delta)  }{\sigma}\right\} }$$



## Weibull distribution (Type I)

$$ G(t, \Psi) = exp \left\{ - \exp \left[ - \frac{ \log \left[ \Psi  - \left( \frac{\theta _H}{t} \right) + \delta \right] - \log(\Psi_{b50} + \delta)  }{\sigma}\right] \right\}$$

## Weibull distribution (Type II)

$$ G(t, \Psi) = 1 - exp \left\{ - \exp \left[ \frac{ \log \left[ \Psi  - \left( \frac{\theta _H}{t} \right) + \delta \right] - \log(\Psi_{b50} + \delta)  }{\sigma}\right] \right\}$$

## References
